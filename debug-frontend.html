<!DOCTYPE html>
<html>
<head>
    <title>Frontend Auth Debug Test</title>
</head>
<body>
    <h1>Frontend Authentication Debug</h1>
    <button id="test-redirect" style="padding: 10px; margin: 10px;">Test Direct Redirect</button>
    <button id="test-auth-func" style="padding: 10px; margin: 10px;">Test Auth Function</button>
    <div id="debug-output" style="margin: 20px; padding: 20px; border: 1px solid #ccc;"></div>

    <script>
        const debugOutput = document.getElementById('debug-output');
        
        function log(message) {
            console.log(message);
            debugOutput.innerHTML += message + '<br>';
        }

        // Test 1: Direct redirect
        document.getElementById('test-redirect').addEventListener('click', function() {
            log('🧪 Test 1: Direct redirect to /api/login');
            try {
                log('Current location: ' + window.location.href);
                log('About to redirect...');
                window.location.href = '/api/login';
                log('Redirect command executed');
            } catch (error) {
                log('❌ Error: ' + error.message);
            }
        });

        // Test 2: Simulate the auth function
        document.getElementById('test-auth-func').addEventListener('click', function() {
            log('🧪 Test 2: Simulating auth function');
            
            function isMobileEnvironment() {
                const hostname = window.location.hostname;
                const userAgent = navigator.userAgent;
                
                log('Environment check - hostname: ' + hostname);
                log('User agent: ' + userAgent.substring(0, 100));
                
                if (hostname.includes('f9f72fa6-d1fb-425c-b9c8-6acf959c3a51-00-2v7zngs8czufl.riker.replit.dev')) {
                    log('Detected mobile dev environment');
                    return true;
                }
                if (hostname.includes('app.ascended.social')) {
                    log('Detected mobile prod environment');
                    return true;
                }
                if (userAgent.includes('Expo') || userAgent.includes('ReactNative')) {
                    log('Detected React Native/Expo environment');
                    return true;
                }
                
                log('Detected web environment');
                return false;
            }
            
            function getAuthUrl(redirectUrl) {
                const baseUrl = '/api/login';
                log('Base URL: ' + baseUrl);
                
                const isMobile = isMobileEnvironment();
                log('Is mobile: ' + isMobile);
                
                if (isMobile) {
                    const state = JSON.stringify({
                        platform: 'mobile',
                        callback: redirectUrl || window.location.origin + '/auth-callback',
                        redirectUri: redirectUrl || window.location.origin
                    });
                    const finalUrl = baseUrl + '?state=' + encodeURIComponent(state);
                    log('Generated mobile auth URL: ' + finalUrl);
                    return finalUrl;
                } else {
                    const finalUrl = redirectUrl ? baseUrl + '?redirectUrl=' + encodeURIComponent(redirectUrl) : baseUrl;
                    log('Generated web auth URL: ' + finalUrl);
                    return finalUrl;
                }
            }
            
            function initiateAuth(redirectUrl) {
                try {
                    log('🚀 initiateAuth() called with: ' + (redirectUrl || 'undefined'));
                    
                    const authUrl = getAuthUrl(redirectUrl);
                    log('🔗 Generated auth URL: ' + authUrl);
                    log('🌐 Current window.location: ' + JSON.stringify({
                        href: window.location.href,
                        origin: window.location.origin,
                        hostname: window.location.hostname,
                        pathname: window.location.pathname
                    }));
                    
                    log('⏳ About to redirect to: ' + authUrl);
                    window.location.href = authUrl;
                    log('✅ Redirect command executed');
                    
                    setTimeout(() => {
                        log('🔍 Post-redirect check - current URL: ' + window.location.href);
                    }, 100);
                    
                } catch (error) {
                    log('❌ Error in initiateAuth(): ' + error.message);
                    log('❌ Error stack: ' + error.stack);
                }
            }
            
            // Test the auth function
            initiateAuth();
        });
        
        log('🧪 Debug test page loaded');
        log('Current URL: ' + window.location.href);
        log('User Agent: ' + navigator.userAgent.substring(0, 100));
    </script>
</body>
</html>